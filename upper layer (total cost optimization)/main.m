 %% UPPER LAYER
% l'upper layer ha due compiti: calcolare istante per istante l'ingresso
% ottimo di controllo a seconda della strategia selezionata e applicarlo al sistema, 
% è quindi un controllo a ciclo aperto. inoltre, definisce gli ingressi 
% e gli stati di riferimento che entreranno nell'MPC. viene inoltre simulato 
% l'andamento del sistema
tic
clear all
close all

Ts=300;                     %tempo di campionamento 5 minuti                  
Ns=3600*24/1/Ts;            % numero di campioni necessari per simulare 24h -> 288

% parametri
Ccap=30000;
kcov=10;
h=7;
ru=1.225;
Cair=1003;
LAI=2.6;
gamma=0.008;
rb=150;
L=2450;
% Tout è la temperatura esterna, varia tra 7 e 20 gradi
Tout=[10.6800000000000,10.4900000000000,10.3400000000000,10.2500000000000,10.0700000000000,10.0200000000000,9.93000000000000,9.83000000000000,9.79000000000000,9.70000000000000,9.69000000000000,9.59000000000000,9.48000000000000,9.36000000000000,9.28000000000000,9.25000000000000,9.28000000000000,9.30000000000000,9.32000000000000,9.31000000000000,9.26000000000000,9.19000000000000,9.15000000000000,9.12000000000000,9.11000000000000,9,8.98000000000000,8.91000000000000,8.78000000000000,8.72000000000000,8.67000000000000,8.71000000000000,8.72000000000000,8.72000000000000,8.68000000000000,8.65000000000000,8.64000000000000,8.58000000000000,8.50000000000000,8.41000000000000,8.38000000000000,8.47000000000000,8.43000000000000,8.44000000000000,8.43000000000000,8.42000000000000,8.38000000000000,8.34000000000000,8.20000000000000,8.19000000000000,8.16000000000000,8.10000000000000,7.96200000000000,7.94600000000000,7.93900000000000,7.90300000000000,7.86800000000000,7.98900000000000,8.17000000000000,8.15000000000000,8.05000000000000,7.83800000000000,7.39700000000000,7.43000000000000,7.20100000000000,7.16000000000000,7.08900000000000,7.22100000000000,7.39700000000000,7.43400000000000,7.38500000000000,7.48600000000000,7.45100000000000,7.47000000000000,7.20500000000000,7.28400000000000,7.34500000000000,7.33400000000000,7.31000000000000,7.28300000000000,7.32500000000000,7.28900000000000,7.33700000000000,7.26500000000000,7.32300000000000,7.46800000000000,7.74600000000000,8.18000000000000,8.36000000000000,8.74000000000000,9.51000000000000,10.0300000000000,10.2000000000000,10.2200000000000,10.4100000000000,10.6400000000000,10.7400000000000,11.0600000000000,11.0800000000000,11.4900000000000,12.1500000000000,12.4100000000000,13.1700000000000,13.1400000000000,13.6400000000000,14.3600000000000,14.8800000000000,14.2200000000000,15.3000000000000,15.8500000000000,15.8400000000000,16.2100000000000,16.3900000000000,15.5600000000000,14.9000000000000,15,14.8700000000000,14.6600000000000,15.1000000000000,15.3600000000000,15.9200000000000,15.5600000000000,14.9200000000000,15.6500000000000,16.2100000000000,15.7900000000000,15.7400000000000,15.4200000000000,14.3100000000000,15.3100000000000,16.0200000000000,15.2400000000000,15.9600000000000,16.2200000000000,15.9700000000000,15.9100000000000,16.1900000000000,16.2100000000000,16.5500000000000,17.2600000000000,16.7600000000000,17.0200000000000,17.1800000000000,16.7100000000000,16.7500000000000,17.8000000000000,17.1700000000000,16.9800000000000,17.2800000000000,16.9100000000000,17.1800000000000,17.7800000000000,17.6700000000000,18.0800000000000,17.9300000000000,17.8600000000000,18.2500000000000,18.6100000000000,18.0200000000000,18.4200000000000,18.5900000000000,18.6400000000000,18.2600000000000,18.6000000000000,18.3600000000000,18.3200000000000,18.2500000000000,18.3200000000000,18.8000000000000,18.1100000000000,19.3200000000000,19.3400000000000,19.5200000000000,19.7800000000000,19.6400000000000,19.5000000000000,19.1100000000000,19.4200000000000,19.7300000000000,19.7000000000000,19.9000000000000,20.0500000000000,20,19.4800000000000,19.2400000000000,19.5600000000000,19.4100000000000,19.5500000000000,19.0600000000000,19.2200000000000,18.7700000000000,18.9600000000000,19.3300000000000,19.0600000000000,19.5400000000000,19.2400000000000,18.9500000000000,18.7700000000000,18.5900000000000,18.4500000000000,18.2700000000000,18.1200000000000,17.8100000000000,17.7000000000000,17.6800000000000,17.5700000000000,17.2400000000000,16.9800000000000,16.7200000000000,16.5100000000000,16.3200000000000,16.1200000000000,15.9800000000000,15.8600000000000,15.7400000000000,15.6300000000000,15.4500000000000,15.3700000000000,15.3100000000000,15.2900000000000,15.1200000000000,14.9700000000000,14.8500000000000,14.7800000000000,14.7800000000000,14.8000000000000,14.5800000000000,14.5500000000000,14.4800000000000,14.5200000000000,14.3800000000000,14.3900000000000,14.4900000000000,14.2500000000000,14.0700000000000,13.8400000000000,13.7700000000000,13.6200000000000,13.6900000000000,13.7800000000000,13.8500000000000,13.8000000000000,13.6300000000000,13.5900000000000,13.5400000000000,13.5500000000000,13.5000000000000,13.4200000000000,13.4500000000000,13.4100000000000,13.3800000000000,13.3100000000000,13.2400000000000,13.2400000000000,13.1300000000000,13.1000000000000,13.0600000000000,13.1100000000000,13.0600000000000,12.9900000000000,12.8900000000000,12.8700000000000,12.9400000000000,12.8400000000000,12.8200000000000,12.8800000000000,12.7900000000000,12.6900000000000,12.5100000000000,12.5800000000000,12.7000000000000,12.7100000000000,12.7000000000000,12.6300000000000,12.5200000000000,12.6200000000000,12.7500000000000,12.7100000000000,12.5100000000000,12.2400000000000,12.1000000000000,11.8900000000000,11.9500000000000,12.1400000000000,12.1800000000000,12.1300000000000,12.0400000000000,11.9600000000000,11.9400000000000];
% RHout è l'umidità relativa esternae varia tra 30% e 90%
RHout=0.01*[84,84.6000000000000,84.8000000000000,85.1000000000000,85.8000000000000,86.1000000000000,86.2000000000000,86.5000000000000,86.6000000000000,86.9000000000000,86.9000000000000,87.2000000000000,87.5000000000000,87.9000000000000,88.4000000000000,88.7000000000000,88.5000000000000,88.1000000000000,87.8000000000000,87.6000000000000,87.5000000000000,87.7000000000000,87.8000000000000,87.9000000000000,87.8000000000000,88.1000000000000,88.2000000000000,88.3000000000000,88.6000000000000,88.9000000000000,89.1000000000000,89.2000000000000,89.1000000000000,89.1000000000000,89,89.1000000000000,89.1000000000000,88.9000000000000,89.1000000000000,89.4000000000000,89.6000000000000,89.6000000000000,89.3000000000000,89.3000000000000,89.5000000000000,89.4000000000000,89.4000000000000,89.5000000000000,89.6000000000000,90,89.9000000000000,90,90.3000000000000,90.6000000000000,90.7000000000000,90.8000000000000,90.9000000000000,91.1000000000000,90.8000000000000,91.1000000000000,91.3000000000000,91.5000000000000,91.5000000000000,92.1000000000000,92.4000000000000,92.6000000000000,92.9000000000000,93.1000000000000,93.1000000000000,93,92.8000000000000,92.6000000000000,92.2000000000000,92,91.8000000000000,92.1000000000000,92.2000000000000,92.1000000000000,92.2000000000000,92.3000000000000,92.5000000000000,92.4000000000000,92.4000000000000,92.3000000000000,92.4000000000000,92.3000000000000,91.9000000000000,90.9000000000000,88.9000000000000,87,84.8000000000000,80.9000000000000,79.2100000000000,80.3000000000000,79,79.1000000000000,78.5500000000000,77.1700000000000,77.9900000000000,76.0900000000000,73.9700000000000,72.4700000000000,70.0100000000000,69.2800000000000,68.4800000000000,66.1800000000000,64.1500000000000,66.3400000000000,63.4000000000000,61.7100000000000,61.9000000000000,60.9800000000000,60.1200000000000,63.3400000000000,65.7400000000000,66.3300000000000,67.5500000000000,68.5500000000000,66.4200000000000,66.4200000000000,63.7000000000000,65.8800000000000,68.0300000000000,65.6900000000000,63.8900000000000,65.7000000000000,66.0100000000000,67.3900000000000,71.8100000000000,69.2300000000000,66.8600000000000,68.4700000000000,66.6300000000000,65.6900000000000,66.8600000000000,67.4900000000000,66.7100000000000,66.5300000000000,66.8000000000000,64.2000000000000,65.7300000000000,64.1900000000000,64.2400000000000,66.3500000000000,65.3500000000000,62.3500000000000,63.1700000000000,64.6200000000000,62.4900000000000,64.5400000000000,62.9900000000000,61.3600000000000,62.1700000000000,59.7800000000000,59.3000000000000,59.9300000000000,59.0300000000000,58.1300000000000,59.5400000000000,57.8700000000000,57.0100000000000,56.2100000000000,56.9000000000000,56.0800000000000,56.7800000000000,57.4000000000000,55.9500000000000,56.4100000000000,55.3300000000000,57.1300000000000,52.7100000000000,52.4400000000000,51.3700000000000,52.0900000000000,52,52.4700000000000,52.9500000000000,50.6100000000000,50.7100000000000,49.9500000000000,49.9900000000000,49.3100000000000,50.2200000000000,51.7600000000000,52.0400000000000,51.4700000000000,51.8800000000000,51.7800000000000,52.6300000000000,52.5600000000000,53.4500000000000,52.6800000000000,51.8100000000000,52.5400000000000,51.6100000000000,52.6700000000000,54.6000000000000,55.0700000000000,55.4100000000000,55.9700000000000,55.9700000000000,56.6400000000000,58.0300000000000,58.7800000000000,58.8600000000000,59.5400000000000,60.6600000000000,61.1600000000000,62.2500000000000,62.8700000000000,63.3700000000000,64.3100000000000,65,65.6800000000000,66.1300000000000,66.6300000000000,67.6000000000000,68.0500000000000,68.3000000000000,68.4900000000000,69.4800000000000,70.1700000000000,70.5500000000000,70.9900000000000,71.3100000000000,71.4200000000000,72.2900000000000,73.4000000000000,73.5300000000000,74.4700000000000,73.9600000000000,73.6600000000000,73.3600000000000,74.1000000000000,75.0500000000000,76.3600000000000,76.5000000000000,77.1400000000000,76.6100000000000,76.2300000000000,75.8000000000000,75.8700000000000,76.4200000000000,76.3000000000000,76.4800000000000,76.3500000000000,76.4200000000000,76.8600000000000,76.6600000000000,76.9100000000000,77.0700000000000,77.2100000000000,77.7900000000000,77.8100000000000,78.3700000000000,78.5300000000000,78.8000000000000,78.7600000000000,78.8000000000000,79.2300000000000,79.6200000000000,79.9500000000000,79.8200000000000,79.5100000000000,80.3000000000000,80.1000000000000,80.2000000000000,80.7000000000000,81.3000000000000,81.8000000000000,81.3000000000000,81,81.2000000000000,81.6000000000000,81.8000000000000,81.5000000000000,81.4000000000000,81.1000000000000,81.3000000000000,82.1000000000000,82.9000000000000,83.6000000000000,84.1000000000000,83.6000000000000,83.1000000000000,83.1000000000000,83.4000000000000,83.4000000000000,83.9000000000000];
Hout=5.5638*exp(0.0572*Tout).*RHout;                          
% Cout è l'anidride carbonica esterna: 407ppm
Cout=407*1977*10^-6*ones(1,24*3600/Ts);
% Qsun è l'irradiazione solare. varia tra 0 (assenza sole) e 610 (ora di
% picco)
Qsun=0.7*[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.01080800000000,2.68696000000000,5.35473000000000,11.1125100000000,19.9794800000000,31.0280100000000,44.3476700000000,58.8764600000000,73.0661800000000,89.9172700000000,106.147800000000,120.580400000000,134.708300000000,149.438300000000,164.125000000000,176.729800000000,190.006500000000,204.359800000000,218.980000000000,235.174300000000,253.154500000000,270.822700000000,286.950700000000,304.812300000000,321.472000000000,335.336900000000,347.627500000000,356.785400000000,361.089800000000,374.782200000000,392.861600000000,404.460400000000,405.891000000000,421.156700000000,426.096800000000,450.012600000000,474.030200000000,481.541600000000,484.051000000000,481.672400000000,429.432500000000,530.512800000000,537.894200000000,552.916200000000,569.863600000000,575.429300000000,586.536700000000,588.313300000000,597.810500000000,610.548000000000,605.570200000000,603.931300000000,627.881400000000,638.322700000000,645.692300000000,633.175800000000,631.744700000000,653.391300000000,655.997500000000,651.224700000000,660.299900000000,660.266100000000,667.069300000000,667.685000000000,670.902900000000,675.335800000000,678.076200000000,641.543300000000,627.148700000000,671.827400000000,649.561600000000,643.690100000000,644.328900000000,622.344200000000,643.511100000000,646.501200000000,636.515100000000,639.462600000000,636.295000000000,605.882400000000,603.750200000000,593.799100000000,592.970700000000,607.007100000000,594.817900000000,576.495000000000,559.548000000000,554.852500000000,534.579900000000,532.050500000000,527.196400000000,509.772800000000,492.215100000000,469.394600000000,457.002100000000,461.011800000000,451.184600000000,427.417500000000,415.542200000000,408.560500000000,392.147000000000,380.984000000000,369.326800000000,347.618500000000,329.214800000000,314.072800000000,302.577800000000,287.328700000000,274.906600000000,263.546000000000,250.067100000000,229.323600000000,212.396700000000,196.814500000000,177.903500000000,162.533200000000,145.060000000000,131.334100000000,114.523500000000,97.6162300000000,83.9706100000000,70.7720900000000,57.8163900000000,43.7058900000000,32.1999400000000,22.2636900000000,13.0289600000000,6.22077400000000,1.55201100000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
% Qlamp è la lighting power. vale 110 dalle 18:00 alle 6:00, vale 0 dalle
% 6:00 alle 18:00
Qlamp=[110*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),0*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts),110*ones(1,3600/Ts)] ;

% valori iniziali stato
T(1)=20;
H(1)=13;                    %% umidità relativa impostata a 0.74
C(1)=500*10^-6*1977;        %% 500ppm
RH(1)=H(1)/(5.5638*exp(0.0572*T(1)));

T2(1)=20;
H2(1)=13;                    %% umidità relativa impostata a 0.74
C2(1)=500*10^-6*1977;        %% 500ppm
RH2(1)=H2(1)/(5.5638*exp(0.0572*T2(1)));
% ingressi di controllo: Qc, gv, Cinj
% valore u iniziale
u0=[0.1*ones(1,Ns);
    0.0*ones(1,Ns);
    0.0*ones(1,Ns)];

%% FUNZIONE DI OTTIMIZZAZIONE
%options = optimoptions(@fmincon, 'Algorithm', 'sqp', 'MaxFunctionEvaluations', 750000, 'MaxIterations', 1200);
options = optimoptions('fmincon','Algorithm','interior-point','MaxFunctionEvaluations',75000,'MaxIterations',1200);
% vincoli sugli ingressi accettati di default da fmincon
lb=[-200*ones(1,Ns);zeros(1,Ns);zeros(1,Ns)];                    %Qc_min=-200, gv_min=0, Cinj_min=0;
ub=[200*ones(1,Ns);0.02*ones(1,Ns);0.02*ones(1,Ns)];             %Qc_max=200, gv_max=0.05, Cinj_max=0.05;
%andiamo a calcolare u risolvendo il problema di ottimizzazione 
[u,fval,exitflag]=fmincon(@obj,u0,[],[],[],[],lb,ub,@(u)nonlcon(u,Ts,Ns),options);

%[u2_ref,fval,exitflag]=fmincon(@obj2,u0,[],[],[],[],lb,ub,@(u)nonlcon(u,Ts,Ns),options);
 
u1=u(1,:);
u2=u(2,:);
u3=u(3,:);

%u11=u2_ref(1,:);
%u22=u2_ref(2,:);
%u33=u2_ref(3,:);

% controllo a ciclo aperto
for k=1:Ns                      
    
    %strategia 1
    Qcov(k)=kcov*(T(k)-Tout(k));                                            
    Qvent(k)=u2(k)*ru*Cair*(T(k)-Tout(k));

    Rn(k)=0.86*(1-exp(-0.7*LAI))*(Qsun(k)+Qlamp(k));                         
    rs(k)=(82+570*exp(-gamma*Rn(k)/LAI))*(1+0.023*(T(k)-20)^2);
    epsi(k)=0.7584*exp(0.0518*T(k));
    ge(k)=2*LAI/((1+epsi(k))*rb+rs(k));
    Hsat(k)=5.5638*exp(0.0572*T(k));
    Hcrop(k)=Hsat(k)+epsi(k)*rb/(2*LAI)*Rn(k)/L;
    Qtrans(k)=ge(k)*L*(Hcrop(k)-H(k));
    pgc=1.8*10^-3;
    Tcov(k)=(T(k)+2*Tout(k))/3;
    if T(k)>Tcov(k)
        gc(k)=pgc*(T(k)-Tcov(k))^(1/3);
    else 
        gc(k)=0;
    end
    Hcov(k)=gc(k)*(0.2522*exp(0.0458*T(k))*(T(k)-Tout(k))-(Hsat(k)-H(k)));  
    Htrans(k)=ge(k)*(Hcrop(k)-H(k));                                               
    Hvent(k)=u2(k)*(H(k)-Hout(k));                                           
    Cass(k)=2.2*10^(-3)/(1+0.230/C(k))*(1-exp(-0.0015*(Qsun(k)+Qlamp(k))));
    Cvent(k)=u2(k)*(C(k)-Cout(k));
    T(k+1)=T(k)+Ts/Ccap*(u1(k)-Qtrans(k)-Qcov(k)-Qvent(k)+Qsun(k)+Qlamp(k));   
    H(k+1)=H(k)+Ts/h*(Htrans(k)-Hcov(k)-Hvent(k));
    C(k+1)=C(k)+Ts/h*(u3(k)-Cass(k)-Cvent(k));
    RH(k+1)=H(k+1)/(5.5638*exp(0.0572*T(k+1)));

    % strategia 2
    %Qcov(k)=kcov*(T2(k)-Tout(k));                                            
    %Qvent(k)=u22(k)*ru*Cair*(T2(k)-Tout(k));
    %Rn(k)=0.86*(1-exp(-0.7*LAI))*(Qsun(k)+Qlamp(k));                         
    %rs(k)=(82+570*exp(-gamma*Rn(k)/LAI))*(1+0.023*(T2(k)-20)^2);
    %epsi(k)=0.7584*exp(0.0518*T2(k));
    %ge(k)=2*LAI/((1+epsi(k))*rb+rs(k));
    %Hsat(k)=5.5638*exp(0.0572*T2(k));
    %Hcrop(k)=Hsat(k)+epsi(k)*rb/(2*LAI)*Rn(k)/L;
    %Qtrans(k)=ge(k)*L*(Hcrop(k)-H2(k));
    %pgc=1.8*10^-3;
    %Tcov(k)=(T2(k)+2*Tout(k))/3;
    %if T2(k)>Tcov(k)
    %    gc(k)=pgc*(T2(k)-Tcov(k))^(1/3);
   % else 
    %    gc(k)=0;
   % end
   % Hcov(k)=gc(k)*(0.2522*exp(0.0458*T2(k))*(T2(k)-Tout(k))-(Hsat(k)-H2(k)));  
   % Htrans(k)=ge(k)*(Hcrop(k)-H2(k));                                               
   % Hvent(k)=u22(k)*(H2(k)-Hout(k));                                           
    %Cass(k)=2.2*10^(-3)/(1+0.230/C2(k))*(1-exp(-0.0015*(Qsun(k)+Qlamp(k))));
    %Cvent(k)=u22(k)*(C2(k)-Cout(k));
    %T2(k+1)=T2(k)+Ts/Ccap*(u11(k)-Qtrans(k)-Qcov(k)-Qvent(k)+Qsun(k)+Qlamp(k));   
    %H2(k+1)=H2(k)+Ts/h*(Htrans(k)-Hcov(k)-Hvent(k));
    %C2(k+1)=C2(k)+Ts/h*(u33(k)-Cass(k)-Cvent(k));
    %RH2(k+1)=H2(k+1)/(5.5638*exp(0.0572*T2(k+1)));
end

toc
RH=100*RH;
C=C*10^6/1977;

%RH2=100*RH2;
%C2=C2*10^6/1977;

x=0:1/12:(24-1/12);
x1=0:1/12:24;

figure
subplot (2,1,1)
yyaxis left
plot (Tout,'DisplayName', 'Tout')
ylabel('Temperature(°C)')
xlabel ('Time(hour)')
yyaxis right
plot(100*RHout, 'DisplayName', 'RHout')
ylabel('Relative Humidity(%)')
legend('Outside Temperature', 'Outside Relative Humidity')

subplot(2,1,2)
plot(Qsun)
hold on
plot (Qlamp)
xlabel ('Time(hour)')
ylabel ('Power(W/m^2)')
legend('Solar Irradiation', 'Lighting Power')

figure
subplot(2,3,1)
plot(x,u1)
hold on
%plot(x,u11)
%plot(x,40*u11)          %strat 4
%legend('Heat S4.1','Heat S4.2')
legend('Heat')
hold off
ylabel('Qc(W/m^2)')
xlabel ('Time(hour)')
set(gca,'xlim',[0,24])

subplot(2,3,2)
plot(x,u2)
%hold on
%plot (x,u22)
%legend('Ventilation S4.1','Ventilation S4.2')
legend('Ventilation')
hold off
ylabel('gv(m/s)')
xlabel ('Time(hour)')
set(gca,'xlim',[0,24])

subplot(2,3,3)
plot(x,u3)
%hold on
%plot (x,u33)
%legend('Injection S4.1','Injection S4.2')
%hold off
legend ('Injection')
ylabel('Cinj(g/m^2)')
xlabel ('Time(hour)')
set(gca,'xlim',[0,24])

subplot(2,3,4)
plot(x1,T)
xlabel ('Time(hour)')
ylabel ('Tair(°C)')
legend('temperature')
set(gca,'xlim',[0,24])

subplot(2,3,5)
plot(x1,RH)
xlabel ('Time(hour)')
ylabel ('RHair(%)')
legend('Relative Humidity')
set(gca,'xlim',[0,24])

subplot(2,3,6)
plot(x1,C)
xlabel ('Time(hour)')
ylabel('Cair(ppm)')
legend('CO2')
set(gca,'xlim',[0,24])

