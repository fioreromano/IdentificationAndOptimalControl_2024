
clear
close all
tic
T0=20;
H0=13;
C0=500*10^-6*1977;  %% 500ppm
RH0=H0/(5.5638*exp(0.0572*T0));

%% PARAMETRI DALL'UPPER
T_ref=[20	19.6352891389409	19.4581760006127	19.3173039013588	18.6626944647171	18.1012069677249	17.6814641142069	17.4178451434830	17.1091189618961	16.8462869619742	16.6260775876989	16.4620921581696	16.3097160104572	16.1598796011895	16.0068427010147	15.9072220428815	16.1365734598097	16.0354075518447	15.9055510269377	15.8107249271661	15.7095494500379	15.7039634397061	15.6693639199261	15.6304259348142	15.5789231339963	15.5506752476792	15.5273869053347	15.4915248914279	15.4296071028583	15.3731342350277	15.2900960437126	15.2985136246325	15.2825295865981	15.2065998399501	15.2462022284986	15.2463434681106	15.2042648168448	15.1630286139400	15.1623411082069	15.1813539753359	15.1280786245483	15.1222201327085	15.1263154751065	15.1183721101219	14.9321857635735	14.9549512242724	14.9901472534035	15.0467515032884	15.0306943107349	15.1091676737233	15.0779752245400	15.0643695037685	15.0340346810893	15.0140578886127	14.9949240542038	15.2524857711075	15.5498635208406	15.8363530705671	16.2448025481282	16.5975364882538	16.9192177188498	17.3444423282386	17.6429193103323	17.9481254213846	17.7812024427300	17.8440038148456	18.0846017868721	18.4296487895049	19.1016026427113	19.9668550356741	20.6786193900421	20.7599074394295	20.5774076908411	19.1486916364364	17.6540053207534	17.1284392093909	15.9368310912688	15.3797182339653	14.1122667734669	13.8037822059077	13.7978183527819	13.7945487664821	13.7900497415829	13.7881704104464	14.0446675867394	13.7872475968068	13.8672102345872	13.7977711743984	13.8091413429667	13.8245167789151	13.8404496770747	13.8597054932174	13.9819296283358	14.1813369763757	14.4085434821013	14.7458257271508	15.1318655811896	15.5318414526993	15.9722337373796	16.4238670253902	16.9237091593287	17.4826984218166	18.0510975539688	18.6885355017040	19.3148149300177	19.9541913160858	20.6706685723708	21.4462389845021	22.0935853941126	22.8185255862620	23.5710966531179	24.3152470304042	25.0797753270039	25.7465544954867	25.8098250733279	25.7324034639306	25.7129908650839	25.7215767854069	25.6809287437772	25.6603780897280	25.5825179086446	25.7585531072314	25.4843124413332	25.5760669481842	25.7133760967804	25.7856706814073	25.7504389322714	25.7868989309964	25.8548139311330	25.7820230205702	25.8312603152791	25.9107912003697	25.8877487273499	25.9318616618863	25.9516984557285	25.9588427418684	25.9575134630280	25.9733086769667	25.9743359008678	25.9795116862876	26.0120005887232	26.0109574009630	26.0169423946403	26.0345956773238	26.0361060384292	26.0131988811584	26.0585731243011	26.0560731782286	26.0523549500358	26.0531599919230	26.0506770656007	26.0457802188904	26.0602620941659	26.0603527905158	26.0683843557469	26.0685220017186	26.0688530269741	26.0662328384034	26.0888345475274	26.0786484015132	26.0819491847079	26.0810420309651	26.0870608089028	26.0687001988275	26.0777114398185	26.0692266671653	26.0702190728454	26.0588039721257	26.0353586426964	26.0635321682707	25.9962569057897	26.0433219496248	26.0457041850802	26.0277198806781	26.0444625777941	26.0286832039205	26.0299826606745	26.0117307312802	25.9836661136570	26.0044633655966	25.9793547440901	25.9831979763312	25.9733885106721	25.9734882580556	25.9695305193026	25.9067845351753	25.8676255345979	25.8272451868677	25.8367238179369	25.7376396191103	25.7467263809349	25.6948234464415	25.7151456832056	25.7756355573576	25.7710882813870	25.8066805757899	25.7613099985867	25.6293185658117	25.3872856003430	25.0880939219942	24.7031293269093	24.2263861052625	23.6954270672634	23.0950188384171	22.2140464143785	21.5899195326715	21.0055550636587	20.3862501974841	19.7614813939990	19.1545874350694	18.5693622139946	18.0102690727681	17.5550804171686	17.1732066488019	16.8105952108873	16.4861902693824	16.2169386579864	16.8686755573337	17.4031765259360	17.8307447422539	18.1845634883349	18.4529895897679	18.5529369393749	18.6124439272601	18.6462222137310	18.6705630614324	18.6917507247500	18.6903265825303	18.6920043778510	18.7532315031940	18.8076998253859	18.8299847809167	18.8542616742691	18.8850121237244	18.8800908040586	18.8483132259781	18.7840059006817	18.7229429370625	18.6555754496072	18.6088825083406	18.5800750779261	18.5722672556424	18.5572325530953	18.5201513009244	18.4860522419354	18.4462915773808	18.4155203190992	18.3864356197470	18.3516126521277	18.3238579299987	18.2951939242248	18.2714673471469	18.2407439531943	18.2040398213623	18.1766737858716	18.1322490433197	18.0931436070772	18.0586156046381	18.0343004001969	18.0113132154391	17.9804435777732	17.9445019947328	17.9042313269327	17.8626248648887	17.8337902656171	17.7810728584441	17.7585806135823	17.7184827734237	17.6788944289415	17.5360455883654	17.5069559382097	17.5102393340493	17.4547863457600	17.4653579789045	17.4061735146606	17.3430379858992	17.3060700925025	17.2953492907539	17.3320869540150	17.3422624886458	17.2246531986495	17.1960460058389	17.1425234770208	17.1051488221491	17.0139500419054	17.0417459096485	17.0541992020155	16.9894594087165	17.0075860863204];
RH_ref=[74.4284465895943	83.0459270439657	87.4307877493714	89.2890296577898	89.5272553853498	89.5764227513497	89.6793894000204	89.7947636787619	89.8052036129001	89.8160541991682	89.8364989528815	89.8225496143108	89.8232122664087	89.8274485238989	89.8236234042223	89.8515773359814	89.7906543707500	89.8417396685935	89.8376752137240	89.8284176855454	89.8316384279969	89.8113679341654	89.8155980080936	89.8134131820355	89.8205910655391	89.8140157872993	89.8117899678431	89.8145805914672	89.8175678433142	89.8108924264254	89.8252362771823	89.8136620266460	89.8218363726427	89.8402543726767	89.8289220726563	89.8290184765612	89.8361223568819	89.8460240478743	89.8390953617351	89.8361901562635	89.8524489505884	89.8573757357394	89.8793759827967	89.8902258901437	89.8939662349197	89.9126427141174	89.9287303697419	89.9406467795231	89.9621295474023	89.9768032842757	90.0033366290850	90.0189447017543	90.0331295235144	90.0448620942062	90.0592318980626	90.0818629589905	90.0933931296792	90.1041035038174	89.5007574216193	89.4052279077818	89.3860432550209	88.6923566091449	88.6134580242607	88.1273874293830	90.1095554635363	90.1101360709101	89.1516694580367	87.8685886286627	85.3882103173434	82.7409139069454	81.3772394669852	82.9415570857033	85.1863530569547	90.0266736267091	90.2585105734137	90.3093909884492	90.3538939508126	90.3933883943597	90.4134875477033	90.4341412513047	89.7896824667186	89.3156168696977	88.9674788541246	88.7372065499250	87.2598167008202	88.7786403018887	88.4549070053566	89.2520516938636	89.8584881444171	90.3516011682253	90.2699109107611	90.2193799355198	89.9919898468020	89.8054793362292	89.8795723566799	89.8604891752091	89.8892312076571	89.8955910646954	89.8704130292950	89.8206805252827	89.7216664003636	89.6919243412197	89.6753068226058	89.6452373743806	89.6191051445608	89.6107050312635	89.5787050953779	89.5311962355174	89.5866754364816	89.1320667939949	88.8775385777335	88.2446073791798	86.9520589552032	84.1096184466390	77.8169986554591	76.2018653026317	76.3134505426128	75.9769342859307	75.0655879860967	74.1828527128855	73.3957533811589	77.0633166834697	83.1057602046745	82.0927963358675	73.0620657614584	71.1542765963039	70.7144666600352	70.9510286988368	71.1857929774030	71.8125433438109	72.1147228653209	69.8764421905420	71.1643853925174	69.8502550268549	68.7772788434713	69.1642174009164	69.3805019107631	68.9894510898440	68.8571251124388	68.0704057668205	66.8397346190378	67.8690803219723	66.7118890694541	66.9433187727014	67.7519470699738	67.5455682786670	64.9811358697436	66.6431114059410	66.8206353219732	66.3997119944274	68.3587611296174	65.5656185478793	65.6642625633005	65.9434973112581	64.4641484821703	65.3316225088422	65.3692663575736	64.7481589991099	63.8877160685711	64.6380547149591	63.5814632976063	63.9846763710093	63.5960225637477	64.6897625632743	64.2008028219399	64.7197819157706	64.8566090235776	64.5356461404824	64.7837017223268	64.9034191183219	65.8948077738202	63.3227526535654	63.2317723363222	62.9174161914464	64.0423069200256	64.1137875809039	65.4417340550494	66.2232518093740	64.5656326134584	65.8496477986080	66.0513086069215	66.2983266581468	66.7599889118751	67.9244577340293	69.5291367530058	76.8197977255143	78.6255534217634	72.2437126597934	74.2850666767789	75.0697725041065	77.2909912196496	78.1076433544346	79.8759594477587	82.0566215974507	84.0153779619379	85.6392991331369	86.8950224613170	87.8358456244733	88.4137600680759	88.5714836203789	88.6384372690495	88.6490088000560	88.6836526066034	88.6996181905985	82.3663203025996	88.6250670336808	89.2633838793907	89.2791886389123	89.2812643120854	89.2876481410646	89.2867264590055	89.1345543366963	89.3211804747767	89.3502440879915	89.4057169446895	89.4363636621937	89.5036538694208	89.5715886518778	89.6061983676980	89.5888271707031	89.5564911739164	89.5685065085539	89.5682024620465	89.5653998438207	89.5704810784413	89.5791181819170	89.5818869278176	89.5828537743294	89.7133262519557	89.3307456536892	89.4114437145084	89.3718796698868	89.3553268166549	89.3502352687315	89.3522617840491	89.3702603887872	89.4062844985356	89.4043274098771	89.4201939672114	89.4064766029358	89.4025700357497	89.3912921866209	89.3890076522131	89.3985737423766	89.3891875054591	89.3951009705215	89.3927581941604	89.3890614789980	89.4037279892174	89.3987175650142	89.4066303555831	89.4131059409319	89.4089921473512	89.4309707926805	89.4316160269496	89.4468465644826	89.4516214151886	89.4605230225459	89.4692879645402	89.4640700696649	89.4783554819496	89.4838414998462	89.5000367353335	89.5131207151569	89.5642558396973	89.3783013114834	89.3806190410384	89.3748814685058	89.3861520735378	89.3918379668721	89.4331196047026	89.4236431770925	89.4141489937603	89.4120301102143	89.4347253483080	89.4284869405270	89.4232137105062	89.4455096470271	89.4231582112757	89.3988902369925	89.4147119509582	89.4310853757877	89.4368697158472	89.4640639865943	89.4720958350648	89.4147118011483	89.3844636617562	89.4002026472407	89.5858593683751];
C_ref=[500	498.100048680659	495.479420010083	491.347468742345	479.948024893257	470.044186794141	462.214472995563	456.469550075728	450.915302465119	446.240160513093	442.388702029006	439.250563454718	436.632581855821	434.425991718270	432.583453012649	431.261134923327	431.255180668641	430.104006907444	428.980997405260	428.122672283145	427.389074717165	427.096793480959	426.796125078096	426.539950049931	426.287377843581	426.160969853339	426.126192128740	426.065810218830	425.974087901451	425.941574250224	425.857892225037	426.056849421284	426.175077808417	426.091369633499	426.364636473543	426.523921884228	426.553159107182	426.580109388139	426.744404793130	426.964774610856	427.005347101838	427.196605713594	427.362292246844	427.506485782932	427.237794511985	427.673069299492	428.139078269520	428.653958942345	428.940683049233	429.532419796283	429.702197521647	429.944438587107	430.122701422010	430.400791613149	430.672736079308	431.856576890267	433.042758880225	434.060347207358	434.918572482583	435.637896646484	436.222796585066	436.706202007183	437.124789616484	437.494136916588	437.815333336429	438.095254405299	438.337323496298	438.531794213668	438.685034957141	438.814936934097	438.940186968054	439.053320335952	439.156231110996	444.864486184925	446.959700380825	452.399048651913	453.558444325641	457.554724155542	455.673094064721	460.321226231510	466.359334939221	472.403150089983	478.400376613510	484.264501646284	490.007266021530	495.514944229874	500.627470338297	505.301980277790	509.437074364498	512.094724795400	510.779596156427	506.185053510220	501.186141954136	496.690688119282	492.428416865776	488.793018540174	484.867611169456	480.517213141034	475.830380774561	470.759540549293	465.472730072277	459.971325580227	454.260035321215	448.535106009379	443.191800294910	438.028514919648	433.451164139131	429.594710903081	426.232469046423	423.218547956115	420.719068843147	418.107923043918	415.037951911118	411.650233286616	409.761747947348	409.866474817646	410.124566659642	409.774443665484	409.477320943166	409.704599057824	412.393410526134	413.971121486011	412.842839165971	409.072769696346	408.755155239216	408.879812008894	409.750388899896	410.310100409381	410.551457677531	410.337554616791	409.302289933105	410.214949833810	409.365977385812	408.808870041293	409.036551430539	408.958774219520	408.949106913492	408.907344779696	408.338096608130	407.910368758579	408.570504929107	408.105770308590	408.154588232042	408.424299727634	408.485887879638	407.416783641580	408.255016929916	408.148469751651	408.286496208531	409.202340863619	407.775980677853	407.787552416941	408.117950760261	407.648265678301	408.312602200452	407.979770990959	407.637640760658	407.549859929531	408.047334581431	407.604667242247	407.997708026117	407.971409949669	408.490743055579	408.060149905641	408.171089497976	408.311584371738	408.528562739369	408.660682533577	408.461039474447	409.130966851224	408.117305597861	408.381158189655	408.444470253446	408.835728999454	408.994629961980	409.680179481501	409.821759246183	409.426031001761	409.993360050810	410.110750450223	410.288540386605	410.736143713967	411.471808915996	412.806844364189	416.455979451373	415.745480058598	413.800492159124	414.182651451938	414.545797292485	415.423375585086	416.198545930758	416.755849891795	417.237383664024	417.750517382994	418.155438837245	418.503432494447	418.957288544783	419.448719220966	420.056441299888	420.702938056969	421.541045123040	422.581931960313	423.737832553851	424.962974045133	423.639460480387	427.060818078267	429.028344658603	430.734823465958	432.414437213014	433.990325639700	435.406928580117	436.453417925675	437.796995380572	439.050918876424	440.136104060849	441.205860919820	442.486543412635	440.789100600022	438.477463402557	435.922998471308	433.452427272283	431.137946406214	428.693300144977	426.635381951305	424.932038732269	423.550821090505	422.457957888109	421.618926245652	420.992316669228	420.493297550064	420.172336637919	419.919238030948	419.741185387784	419.598447325870	419.476714375964	419.360869512637	419.247874571573	419.161795686811	419.105872228023	419.075949140454	419.063805363018	419.073951453120	419.081884200540	419.084615852230	419.093351842794	419.095110086514	419.100527590841	419.109244576976	419.110641548961	419.105933691438	419.098961299483	419.094604852231	419.083413627839	419.063324504631	419.046335229210	419.017560048387	418.996656218975	418.983611362938	418.969602454813	418.964970462625	418.954520917620	418.946873926135	418.919991325374	418.864671689186	418.860191464822	418.721488697541	418.683080745203	418.640776814646	418.608859253863	418.435683787457	418.433054354238	418.442581147252	418.354498861558	418.378644366020	418.286590808164	418.213654718263	418.151435893586	418.084428712387	418.079583740946	418.023174983801	417.745631597915	417.560560299497	417.257291669733	416.831084296520	416.148074946985	415.520420227445	414.731247717393	413.723195185625	412.781391672857];

T_ref=repelem(T_ref,5);
RH_ref=repelem(RH_ref,5); 
C_ref=repelem(C_ref,5);

u1_ref=[31.2803738831016	30.5437431846941	28.7734922067894	-4.09037160933494	-3.09964381301892	-0.122875364609178	5.38394276502510	0.00381304977994990	-0.587635410380900	-0.483525206024786	0.593119359491901	-0.00484469939259858	-0.998405656276383	-2.18010200549976	-0.0787412537961822	21.2011291304167	1.59019986351542	-1.85658365066236	-1.47963177719471	-3.25563590464246	2.27843236625797	0.733661140412239	0.311584841316047	-0.866438074402667	0.0898406344586425	0.909949118893991	-0.0967319754960399	-1.82148490889455	-1.24346544039916	-3.35948170933957	2.10882111163057	0.292999738817884	-4.09719408229240	2.66549707553424	0.782505596727209	-1.82455413176684	-2.31268690830206	0.225728601868422	2.11522732117869	-1.82676048098122	0.858260476888187	0.716733789664603	0.130506223824169	-11.8309726894990	-0.465126482385968	0.637240535076402	2.74149650092597	-1.11638006832766	5.77195292697134	-0.337147506996734	0.533375549094996	-0.378296113385707	0.817661028289349	0.732394817745272	18.2620640425101	24.2847354773650	27.5016830142375	42.4614979012452	41.8107216981142	44.1739652957186	60.1174979968286	56.8961070471483	66.3798948949149	24.1438220507969	43.2151099322775	62.1996023310941	78.5303225959438	117.204663260609	149.038797245975	150.309309956637	99.3715806037717	69.3469123022068	18.3594537441511	18.7580521718121	69.7446198494841	22.8573988221577	52.5345835484563	1.57581613249596	52.5655850704726	74.0508677318759	74.5527530030752	74.5757883674977	73.6889058648283	98.8091424465438	47.9152858918465	70.2093894177208	46.9916746307548	40.9134927673715	31.5206303919211	23.4718655509798	8.59022961535002	3.43384435927678	1.85455588175948	-1.27131835986927	1.11489496536175	0.135403657961241	-0.298720333930580	-0.479268166059010	0.605512204030109	1.13849317494586	0.152170749337754	-0.642670657423500	-1.27536873667546	1.07363972473362	-1.04946897484908	-0.532092075093636	1.65780714564698	0.132125396972462	-0.992442424979037	-0.514468393234209	-0.376489361851057	-0.968063071129383	0.603803256978197	0.122724056597689	0.482779970283662	0.329288878109037	0.183697845016621	-0.179908927695456	-0.435574546064527	-1.42675068441845	-20.1040283798813	-71.0736450674995	-55.6176047620274	-5.67946223906428	-4.05135566146368	-3.78260704345813	-0.806690325272280	1.87252102737929	3.16105314091617	-5.77298827104183	0.700024376973506	-5.10240571728095	0.573803624811730	-0.620385238097512	-0.640362486802849	-2.94028908652203	-0.732598014862899	-0.565354705324113	0.197001447979966	-1.59506389242100	-0.184500200132508	-0.192524239259470	-0.735186529377881	0.260996400729836	-4.45262233228057	0.330085408895028	-2.09694179345497	-1.08035475108115	-0.572530636570689	-5.26766498347703	-0.489320655512952	-1.60351638158394	-0.283340231117227	-1.10099523330780	-0.728732471372594	-4.15559954558820	-8.00741965145593	-3.74997599121053	2.03611092220095	-0.534806537700190	-0.479319579704583	-0.652661662140653	-0.852082028419190	-4.02067355868629	-5.98050025812950	-2.36136350647988	-0.00283038136393522	1.94557993233528	-4.04072969689469	-0.0213912481125505	-2.67794991199679	-0.494529162210673	-0.923894530335833	-3.04670419356163	0.678865480485797	-0.313380501615070	-2.66839792689174	0.0385273656605827	0.0906728503432209	-2.73957468519888	-2.81116204305207	-4.60461723971662	-4.78377477592940	-1.54837544653639	-36.4560083828383	-36.0305439309668	-0.686312878232079	-2.74086967667947	-2.51462579333549	-1.82650827856767	0.274994000198797	1.14459142964911	0.635312950640053	-1.34590694109490	-1.14695592678862	-0.101740580976846	-0.321893126211251	-1.71567102023947	0.160012169678123	0.528740926451130	0.196230991677291	0.247368338260891	0.00880543798597944	-0.628474651521444	-0.485535196434312	0.924648758812640	-0.226101054158350	-0.546824966629843	-0.241956849263167	-1.45335018325847	-3.82532324820396	-0.0349348339772053	1.66226130138966	-0.768625371494561	-1.21081174092792	0.409063185074538	-0.326075995938176	0.145755822831393	-0.169331838165993	0.416649869258685	0.572495620593663	-7.81024481543135	-8.24877834995241	-8.60736635747799	-8.81103786365364	-8.90829600099896	-7.75283204784865	-7.24911891866564	-0.195789178546262	-0.227180397449029	-0.652425057085855	-0.348429620356226	-0.629882363489226	-0.303561143002901	-0.348525795586287	-0.601844619321414	-0.435649836938755	-0.0534424599593098	-0.215266167022776	-0.500605183128521	-0.0927223883407666	-0.230305457487884	-0.276005202544913	-0.168830936753990	-0.533233384660014	-0.525965108761656	-0.284315977317304	-0.220769046058503	-0.508102834235076	-0.498459186763257	-0.178414696748635	-0.285493317316903	-0.333147966539166	-0.110792883413067	-0.551716052805757	-0.417233681649266	-0.145606478841926	-0.377784736787399	-0.0962929389361310	-0.219921618997597	0.0715150860856058	-0.479147754900833	-1.91099377325218	-0.994657424997040	-1.66998350353439	-0.943529564523362	-1.66500218970058	-1.06789972656100	-7.32755578864801	-1.50422322875962	-0.803236028773234	-5.36079311174810	-1.02142695346032	-5.31126370551322	-5.28301060994599	-5.33175188620259	-5.29737229107907	-1.55831304521923	-0.956273132442072	-7.46087049069142	-1.00194235238839	-1.02166624260569	-0.983993595526378	-7.37594762942845	-0.362098974217141	-0.540934611510642	-5.13044206605597	-0.334665776610669];
u2_ref=[0.000189535813747041	0.000408941176889195	0.000851160995245366	0.00295734207853845	0.00301197401955444	0.00279607624305056	0.00238915283832313	0.00265901214665979	0.00262278880276564	0.00253800161687957	0.00244300286865328	0.00241442811449046	0.00241033155491523	0.00243254683731483	0.00223548181386232	0.000982214196154453	0.00218210376018818	0.00236116220668896	0.00228309187195090	0.00232631462563407	0.00195778468621139	0.00202668295443813	0.00203936794753315	0.00208396450828596	0.00200684003895983	0.00193456274863361	0.00198296664745893	0.00205916297343497	0.00199225968488390	0.00208174755166709	0.00172726036246226	0.00184516903099677	0.00209365794832271	0.00165658226503464	0.00177049626894276	0.00192441528867391	0.00192627696536275	0.00173366524351639	0.00160548004607314	0.00183338823136363	0.00164995755464857	0.00165581195016203	0.00166795896948305	0.00241476054087830	0.00160743568438314	0.00153221476484721	0.00140207004643807	0.00165114319283322	0.00117951336005366	0.00159499391882235	0.00151203664560453	0.00154593652400701	0.00143389783284076	0.00143129307740182	0.000289674885990783	6.19154864864701e-05	3.03812796093018e-05	1.85165381259601e-05	9.16591780753956e-06	1.12118811742958e-05	4.73268569624497e-06	4.74462414040455e-06	4.98309400716840e-06	1.03426922005855e-05	6.90612278038800e-06	1.55664939561656e-06	1.36595863491778e-06	1.29891255337182e-06	1.12714491445379e-06	1.13722702926943e-06	9.65506425868553e-07	1.08405347879017e-06	5.91460564436740e-07	0.00226908492002516	0.000123730081541743	0.00234384431555530	0.000884122302870404	0.00363386665318861	0.000671861123267074	2.06476856945583e-05	3.30030728224586e-05	3.13666116162301e-05	4.16155528838535e-05	4.15768708576036e-05	4.50717687294225e-05	5.78910357263103e-05	5.45833457409894e-05	5.38652604916967e-05	0.000253612974412682	0.00101173923834764	0.00163443274517634	0.00167751116617518	0.00151745208956082	0.00139816944823117	0.00115467054907400	0.00115688182527954	0.00123514441836534	0.00131290855739643	0.00143746685106137	0.00154920853638037	0.00166824480045318	0.00180519279923741	0.00191659871255967	0.00191095247740209	0.00203678059442852	0.00195948932024960	0.00175069624333158	0.00158691908841801	0.00167201575212740	0.00135375756735372	0.00128811490478525	0.00148953855803639	0.00237524279560102	0.00534723022179728	0.00491002444554743	0.00450170534515733	0.00494666770994573	0.00572599042594275	0.00622821464818724	0.00688760564298940	0.00386933178210789	0.00179880426128327	0.00427903845055590	0.00887815789474487	0.00886838993213172	0.00911219163062199	0.00880995151058206	0.00861239867534618	0.00811729413354369	0.00852670926798153	0.0104564390915062	0.00872308595151335	0.0101222567548579	0.0111502949101790	0.0108330967868461	0.0109137305827015	0.0111458851238234	0.0111643192248908	0.0125858257325621	0.0137301866581972	0.0124478306788602	0.0135594137501691	0.0134829012729495	0.0128779325558656	0.0129882943411556	0.0155909046568904	0.0135281311813491	0.0136975736928969	0.0131997125343877	0.0113450422894900	0.0144912105053142	0.0142247351156357	0.0139802819260732	0.0150567556295561	0.0134698352104226	0.0139917601852032	0.0148553776881779	0.0155523746065694	0.0145604232902527	0.0154427722085239	0.0144292581327236	0.0145179624581089	0.0131255687500231	0.0137738087447414	0.0134897152471013	0.0133240474611662	0.0127935513353908	0.0125394891859712	0.0125672871844231	0.0113111249273843	0.0134434634092357	0.0131531988130714	0.0130319590519513	0.0121946851088655	0.0117762344185293	0.0104291288236995	0.00992123400427351	0.0109943855848830	0.00953808945597806	0.00939912214499603	0.00929517984773484	0.00878486051402319	0.00799534136368349	0.00686922548582776	0.00212465567962328	0.00355294130843987	0.00743558968740713	0.00436389719822191	0.00448718327194560	0.00315844820883444	0.00332850382330059	0.00238579040480734	0.00161017728746334	0.00126607888686166	0.00102435995520546	0.000937491028148171	0.000973814742228742	0.00116691843784596	0.00138017888756426	0.00159149467323479	0.00182614370103308	0.00203370459384633	0.00229464395839814	0.00626293493734451	0.000578141442272079	0.00261067435923635	0.00302533182321232	0.00317525982719932	0.00331137106395427	0.00344154748098280	0.00367524625494880	0.00337019978616208	0.00335910049473458	0.00343515802504060	0.00342497583104445	0.00327461039370576	0.00133772709712642	0.00184590938700071	0.00219533265052216	0.00236906049192329	0.00251335555774564	0.00299661283743910	0.00305351379038428	0.00310260558597912	0.00313920677540268	0.00315960860708716	0.00316081906288104	0.00312216103540574	0.00319384041628151	0.00307108434112960	0.00309144708260284	0.00305174026428058	0.00305223027711576	0.00306373986114631	0.00310606036008224	0.00317046352105924	0.00317666027334217	0.00317120586032334	0.00315973472389866	0.00315108765820534	0.00311083289214925	0.00311165691071131	0.00312197039745859	0.00310759775683031	0.00312055365775657	0.00311141897229342	0.00309632505365454	0.00310096935918572	0.00310973146277092	0.00311292719265256	0.00310060598840300	0.00310902819291047	0.00312690648359060	0.00312251454790010	0.00315840025462221	0.00315772705965010	0.00315051789857676	0.00316121092214439	0.00314488512905503	0.00315930677995545	0.00315665042145002	0.00319684073818843	0.00326615399851898	0.00310509128444537	0.00343701817207090	0.00329683641534764	0.00332690202833036	0.00330262137176278	0.00366027976474002	0.00335145460491264	0.00331148735783036	0.00354538993883561	0.00330551014380442	0.00355891938622050	0.00355531455203632	0.00354297679943409	0.00353413223220468	0.00329605003184503	0.00325186953495892	0.00361331887440032	0.00325700807663144	0.00326959869351986	0.00330891573324440	0.00370163385764526	0.00326825636145830	0.00327564801451900	0.00353307798038828	0.00298220620347353];
u3_ref=[0.000218672970169200	0.000224036831581015	0.000229284188090188	0.000237865187014696	0.000246862937357685	0.000255556328421878	0.000263128457194323	0.000270506713277174	0.000278051512136656	0.000284658301526864	0.000291115099622359	0.000297737839054418	0.000303647116955790	0.000310848386422229	0.000315780612684899	0.000310377110838884	0.000315073494714501	0.000319435539485150	0.000322863826707518	0.000326435726919767	0.000328468123654417	0.000329648850158673	0.000330953420130887	0.000331775727117020	0.000333580861974725	0.000334551569034643	0.000335063106879511	0.000336244744203457	0.000336080841403341	0.000336939174960153	0.000336405828997352	0.000337829799821547	0.000338381391646611	0.000337994267113951	0.000338028479448676	0.000338549035386312	0.000338630601982595	0.000337616549681955	0.000335784401268014	0.000337214505943705	0.000337063278699519	0.000336766488359315	0.000336828218279922	0.000348552636155173	0.000347407314819716	0.000347191318338092	0.000345479645352370	0.000347112317979791	0.000341698309202855	0.000342198847739839	0.000342375808305769	0.000341717975815790	0.000341769397131086	0.000342189960431419	0.000331631778227774	0.000321379012586345	0.000312276729328508	0.000304482700890398	0.000297700621028224	0.000291720535618107	0.000286751890159595	0.000283828651862386	0.000281628564211988	0.000279781025731856	0.000277714942145167	0.000275679260593250	0.000273503122337630	0.000271622128157045	0.000270554516127180	0.000270357258436453	0.000269803572594618	0.000269354014040873	0.000263359407405277	0.000266511592174333	0.000260691852727596	0.000263852135709263	0.000265728349326494	0.000276393346546148	0.000279069320284424	0.000280714552448699	0.000282674215881609	0.000282580398679172	0.000281372180666458	0.000281210125912289	0.000282089839013164	0.000282959215386019	0.000282960793644682	0.000282582429063215	0.000281325697444831	0.000281938092574978	0.000284829666684378	0.000287009997413581	0.000287523024538153	0.000286406436615275	0.000285741463056758	0.000287299911269431	0.000289963176881936	0.000294964330072712	0.000303080514177585	0.000313755317141966	0.000324190627839530	0.000335440765028539	0.000348478499352030	0.000364874917898581	0.000384824280345435	0.000407041593639015	0.000428430878836206	0.000445198791515170	0.000464546778927333	0.000472637523525945	0.000475157531062920	0.000472843620498297	0.000476054560422164	0.000557243302910370	0.000644027218389565	0.000655536351947345	0.000659781679551711	0.000689558519631822	0.000720919491081675	0.000843597158593055	0.000795176614991061	0.000596059226127367	0.000608558535471249	0.000760867329672191	0.000790769118006761	0.000845224567059823	0.000850775888070016	0.000855641911711703	0.000837102149327857	0.000807560517980034	0.000900452818084542	0.000822707032270381	0.000826142818087403	0.000877188878561039	0.000876601611235764	0.000885108935889180	0.000872807730816536	0.000846280491862002	0.000863569471322973	0.000907327469807575	0.000865360054569575	0.000888023708972839	0.000899339881246531	0.000901443500250621	0.000851755004770554	0.000916794487059051	0.000898256145089669	0.000909443708966939	0.000915009501831412	0.000809903866670362	0.000889035520896181	0.000883667549652404	0.000850310396827875	0.000891389705678944	0.000841025528894751	0.000852170706741509	0.000858101876669801	0.000874089072896773	0.000846899623118318	0.000870647830939408	0.000833004679947117	0.000855552419341234	0.000813220153572843	0.000827401778739347	0.000844615038919502	0.000839862317370541	0.000822341519032710	0.000792816706375431	0.000823275744084049	0.000736658740585452	0.000774631417619856	0.000766701197883869	0.000764979461449220	0.000742794820635126	0.000744556381140558	0.000714824231073460	0.000694629343748786	0.000725349139114155	0.000681540232577492	0.000671996682749661	0.000678977185605548	0.000677459071523752	0.000697737122053327	0.000798896627221164	0.000532808943275019	0.000474092581628571	0.000599989430937660	0.000546212156144041	0.000554824417635825	0.000519277716259414	0.000501876541826333	0.000465399220618096	0.000424397255735187	0.000389570049170747	0.000359982758309035	0.000335575240230944	0.000315836579181909	0.000300081366032766	0.000287376950609862	0.000277041676641935	0.000268479870397562	0.000261557415909514	0.000256064694943965	0.000263093148243891	0.000254264573218862	0.000251782013901440	0.000250462180524195	0.000250010948770058	0.000250359981337427	0.000251813385885049	0.000254678212736700	0.000258223963819843	0.000262364541046434	0.000267727235596769	0.000273718316813588	0.000280523368823989	0.000280516432750824	0.000281429298893627	0.000283245448412157	0.000285637976420773	0.000288496523011626	0.000293753593299043	0.000299231932220482	0.000304800224313763	0.000310283763396717	0.000315496984970614	0.000320270345380789	0.000323596344776927	0.000327512798673250	0.000329233685649996	0.000330902345592446	0.000331768917485567	0.000332311966650663	0.000332686943267034	0.000333248616307421	0.000334226853108986	0.000334894954176568	0.000335602597017139	0.000336169248239012	0.000336591979607856	0.000336582827960178	0.000336564173502995	0.000336620471250130	0.000336571301624009	0.000336614032862014	0.000336575491610461	0.000336400668987206	0.000336228725432359	0.000336165652390010	0.000336108091308017	0.000335890189311308	0.000335748988504996	0.000335695314144554	0.000335606648965284	0.000335810419180271	0.000335973945196307	0.000336032158630856	0.000336157998783152	0.000336114769076062	0.000336158117441080	0.000336157931590292	0.000336171085269789	0.000336319153956090	0.000334521688592215	0.000336084779124902	0.000336501553728070	0.000336760710928433	0.000336397044659272	0.000337876592617620	0.000337485125914612	0.000337124726900844	0.000337977027266946	0.000337139929196035	0.000337641332787421	0.000337782561460909	0.000337480835430907	0.000336620670368375	0.000333793589591332	0.000330414976003219	0.000327720696085090	0.000322396426727230	0.000315989892581492	0.000309114255357947	0.000302054416320277	0.000291677961619904	0.000280209885542907	0.000268828265685939	0.000257381726884528];
u_ref=[u1_ref;u2_ref;u3_ref];

u1_ref=repelem(u1_ref,5);
u2_ref=repelem(u2_ref,5);
u3_ref=repelem(u3_ref,5);

u_zero=[0;0;0];

%% SIMULAZIONE OPEN LOOP
[Topen, RHopen, Copen] = greenhousemodel_upper(u_ref);
Topen=repelem(Topen,5);
RHopen=repelem(RHopen,5); 
Copen=repelem(Copen,5);
%% MPC
for i=1:1440
    N=60;
    Np=min(5,1441-i); % l'orizzonte di previsione ии 5, poi quando arrivo alla fine diventa 4 poi 3 poi 2 poi 1
 
    u0=[0*ones(1,Np);0*ones(1,Np);0*ones(1,Np)];
    lb=[-200*ones(1,Np);-0.05*ones(1,Np);-0.05*ones(1,Np)];
    ub=[200*ones(1,Np);0.05*ones(1,Np);0.05*ones(1,Np)]; 

    options = optimoptions('fmincon','Algorithm','interior-point','MaxFunctionEvaluations',7500,'MaxIterations',1200);
    [u,fval,exitflag]=fmincon(@(u)obj(u,N,Np,i,T0,H0,C0,RH0),u0,[],[],[],[],lb,ub,@(u)nonlcon(u,N,Np,i,T0,H0,C0,RH0,u_zero),options);
    
    %supponiamo di avere limiti sugli attuatori
    if u(1,1)>150
        u1_delt(i)=150;
    elseif u(1,1)<-150
        u1_delt(i)=-150;
    else
       u1_delt(i)=u(1,1);
    end
    
    if u(2,1)>0.045
        u2_delt(i)=0.045;
    elseif u(2,1)<-0.045
        u2_delt(i)=-0.045;
    else
        u2_delt(i)=u(2,1);
    end
      
    if u(3,1)>0.045
    u3_delt(i)=0.045;
    elseif u(3,1)<-0.045
    u3_delt(i)=-0.045;
    else
    u3_delt(i)=u(3,1);
    end
    
    % rilevo il primo ingresso
    u_zero=u(:,1);
    
    U=[u1_ref;u2_ref;u3_ref];
    u_hb=u+U(:,i:i+Np-1);
  
    %se supero ub e lb, saturo a 200 e -200
    if u_hb(1,1)>200
        u1_sum(i)=200;
    elseif u_hb(1,1)<-200
        u1_sum(i)=-200;
    else
        u1_sum(i)=u_hb(1,1);
    end
    %se supero ub e lb, saturo a 0.05 e -0.05
    if u_hb(2,1)>0.05
        u2_sum(i)=0.05;
    elseif u_hb(2,1)<-0.05
        u2_sum(i)=-0.05;
    else
        u2_sum(i)=u_hb(2,1);
    end
    %se supero ub e lb, saturo a 0.05 e -0.05
    if u_hb(3,1)>0.05
        u3_sum(i)=0.05;
    elseif u_hb(3,1)<-0.05
        u3_sum(i)=-0.05;
    else
        u3_sum(i)=u_hb(3,1);
    end
    
    [T,RH,C]=greenhousemodel(u_hb,N,Np,i,T0,H0,C0,RH0);   

    % APPLICAZIONE DISTURBI
    T=T*(1+0.01*(2*rand-1)); % 1% di disturbo
    RH=RH*(1+0.01*(2*rand-1));
    C=C*(1+0.01*(2*rand-1));
   
    % aggiorno lo stato inziale rispetto all'MPC
    T0=T(1);
    RH0=RH(1);
    if RH0>1
        RH0=1;  % RH deve essere minore del 100%
    end
    C0=C(1);
    H0=RH0*(5.5638*exp(0.0572*T0));
    % creo un vettore che tiene memoria della dinamica, visto che ogni
    % volta sovrascrivo sempre sul passo 1
    Tp(i+1)=T0;
    RHp(i+1)=RH0;
    Cp(i+1)=C0;
    Hp(i+1)=H0;
end
toc
1000*clock;
%quando abbiamo creato Tp partiamo dall'istante 2
Tp(1)=20;
Hp(1)=13;
Cp(1)=500*10^-6*1977;  %% 500ppm
RHp(1)=Hp(1)/(5.5638*exp(0.0572*Tp(1)));

%% PLOT
subplot(3,1,1)
plot(u1_ref)
hold on
stairs(u1_sum)
legend('u1_{open-loop}','u1_{mpc}')


subplot(3,1,2)
plot(u2_ref)
hold on
stairs(u2_sum)
legend('u2_{open-loop}','u2_{mpc}')

subplot(3,1,3)
plot(u3_ref)
hold on
stairs(u3_sum)
legend('u3_{open-loop}','u3_{mpc}')

figure
subplot(3,1,1)
plot(Topen)
hold on
plot(T_ref)
hold on
stairs(Tp)
legend('T_{open}','T_{ref}','T_{mpc}')

subplot(3,1,2)
plot(RHopen)
hold on
plot(RH_ref)
hold on
stairs(100*RHp)
legend('RH_{open}','RH_{ref}','RH_{mpc}')

subplot(3,1,3)
plot(Copen/10^-6/1977)
hold on
plot(C_ref)
hold on
stairs(Cp/10^-6/1977)
legend('C_{open}','C_{ref}','C_{mpc}')  

figure
subplot (3,1,1)
plot(u1_delt)
legend('u1_{delt}')
subplot (3,1,2)
plot(u2_delt)
legend('u2_{delt}')
subplot (3,1,3)
plot(u3_delt)
legend('u3_{delt}')
